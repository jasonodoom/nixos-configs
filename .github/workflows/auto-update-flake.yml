name: Auto Update Flake Inputs

on:
  schedule:
    # Run weekly on Fridays at 6 PM UTC
    - cron: '0 18 * * 5'
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-flake:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v13
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Create or update unstable branch
      run: |
        # Ensure we have the latest main
        git checkout main
        git pull origin main

        # Create or reset unstable branch from main
        git checkout -B unstable
        git push origin unstable --force

    - name: Update flake inputs
      run: |
        cd framework-desktop

        echo "Current flake.lock status:"
        nix flake metadata --json | jq -r '
          .locks.nodes |
          to_entries[] |
          select(.key != "root") |
          "- \(.key): \(.value.locked.rev // .value.locked.narHash // "latest")[0:12]"
        '

        echo "Updating flake inputs..."
        nix flake update

        echo "Updated flake.lock status:"
        nix flake metadata --json | jq -r '
          .locks.nodes |
          to_entries[] |
          select(.key != "root") |
          "- \(.key): \(.value.locked.rev // .value.locked.narHash // "latest")[0:12]"
        '

    - name: Check if updates are available
      id: check-updates
      run: |
        cd framework-desktop
        if git diff --quiet flake.lock; then
          echo "No updates available"
          echo "has_updates=false" >> $GITHUB_OUTPUT
        else
          echo "Updates found"
          echo "has_updates=true" >> $GITHUB_OUTPUT

          # Generate update summary
          echo "## Flake Input Updates" > ../update-summary.md
          echo "Generated on: $(date)" >> ../update-summary.md
          echo "" >> ../update-summary.md

          echo "### Changed inputs:" >> ../update-summary.md
          git diff --name-only | grep -q flake.lock && echo "- flake.lock updated" >> ../update-summary.md

          echo "" >> ../update-summary.md
          echo "### Changes:" >> ../update-summary.md
          echo '```diff' >> ../update-summary.md
          git diff flake.lock >> ../update-summary.md
          echo '```' >> ../update-summary.md
        fi

    - name: Test updated flake
      if: steps.check-updates.outputs.has_updates == 'true'
      run: |
        cd framework-desktop
        echo "Testing updated flake..."

        # Quick syntax check
        nix flake check --accept-flake-config

        # Test that main config builds
        nix build .#nixosConfigurations.perdurabo --dry-run

        # Test dev shells
        for shell in go python node rust devops; do
          echo "Testing $shell development shell..."
          nix develop .#$shell --command echo "$shell shell works"
        done

        echo "All tests passed!"

    - name: Commit and push updates
      if: steps.check-updates.outputs.has_updates == 'true'
      run: |
        cd framework-desktop
        git add flake.lock

        # Create detailed commit message
        {
          echo "auto: update flake inputs"
          echo ""
          cat ../update-summary.md
          echo ""
          echo "Automated update by GitHub Actions"
          echo "All tests passed locally"
        } > ../commit-message.txt

        git commit -F ../commit-message.txt
        git push origin unstable

    - name: Create Pull Request
      if: steps.check-updates.outputs.has_updates == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // Read the update summary
          const summary = fs.readFileSync('update-summary.md', 'utf8');

          const { data: pr } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Auto-update flake inputs',
            head: 'unstable',
            base: 'main',
            body: `${summary}

## Automated Flake Update

This PR contains automated updates to flake inputs. The changes have been tested on the unstable branch.

### Tests Performed:
- Flake syntax validation
- NixOS configuration build check (dry-run)
- All development shells tested

### Next Steps:
This PR will be automatically merged if all CI checks pass, including:
- Build tests via Garnix cache
- Security checks
- Development shell validation

---
Generated by GitHub Actions | ${new Date().toISOString()}`
          });

          console.log(`Created PR #${pr.number}: ${pr.html_url}`);

    - name: Enable auto-merge
      if: steps.check-updates.outputs.has_updates == 'true'
      run: |
        # Get the latest PR number for unstable -> main
        PR_NUMBER=$(gh pr list --head unstable --base main --json number --jq '.[0].number')

        if [ ! -z "$PR_NUMBER" ]; then
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          gh pr merge $PR_NUMBER --auto --squash
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-completion:
    needs: update-flake
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify completion
      run: |
        if [ "${{ needs.update-flake.result }}" == "success" ]; then
          echo "Flake update workflow completed successfully"
        else
          echo "Flake update workflow failed"
          exit 1
        fi