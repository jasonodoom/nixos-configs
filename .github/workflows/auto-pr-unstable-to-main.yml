name: Auto PR unstable to main

on:
  push:
    branches:
      - unstable

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: unstable
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config commit.gpgsign false
          git config tag.gpgSign false

      - name: Fetch main and check for commits to merge
        id: check-commits
        run: |
          git fetch origin main:main

          # Get the commits that are in unstable but not in main BEFORE syncing
          COMMIT_COUNT=$(git log main..unstable --oneline --no-decorate | wc -l | xargs)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "Found $COMMIT_COUNT commits to merge"
            echo "needs_pr=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits to merge"
            echo "needs_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR already exists
        id: check-pr
        run: |
          PR_EXISTS=$(gh pr list --head unstable --base main --state open --json number --jq 'length')
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync main into unstable (only if PR needed and no existing PR)
        if: steps.check-commits.outputs.needs_pr == 'true' && steps.check-pr.outputs.pr_exists == '0'
        run: |
          # Check if main has changes that unstable doesn't have
          BEHIND=$(git rev-list --count unstable..main)

          if [ "$BEHIND" -gt 0 ]; then
            echo "Unstable is $BEHIND commits behind main, syncing via GitHub API..."
            # Use GitHub API to merge main into unstable (automatically signed)
            gh api repos/${{ github.repository }}/merges \
              --method POST \
              --field base=unstable \
              --field head=main \
              --field commit_message="Auto-sync main to unstable"

            # Refresh local branch after API merge
            git fetch origin unstable
            git reset --hard origin/unstable
          else
            echo "Unstable is already up-to-date with main"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0' && steps.check-commits.outputs.needs_pr == 'true'
        run: |
          # Get the commits that are in unstable but not in main
          COMMITS=$(git log main..unstable --oneline --no-decorate | head -10)

          # Count total commits
          COMMIT_COUNT=$(git log main..unstable --oneline --no-decorate | wc -l | xargs)

          # Create PR body
          cat > pr-body.md << 'EOF'
          ## Changes in unstable branch

          This PR merges changes from unstable to main after CI validation.

          ### Commits in this PR:
          EOF

          echo '```' >> pr-body.md
          echo "$COMMITS" >> pr-body.md
          if [ "$COMMIT_COUNT" -gt 10 ]; then
            echo "... and $((COMMIT_COUNT - 10)) more commits" >> pr-body.md
          fi
          echo '```' >> pr-body.md

          cat >> pr-body.md << 'EOF'

          ### CI Checks Required:
          - build-with-garnix
          - format-check
          - security-check
          - test-gnome-desktop

          ---
          Auto-generated PR from unstable branch
          EOF

          gh pr create \
            --title "Merge unstable to main" \
            --body "$(cat pr-body.md)" \
            --base main \
            --head unstable \
            --label "automated"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.check-pr.outputs.pr_exists == '0' && steps.check-commits.outputs.needs_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 2
          PR_NUMBER=$(gh pr list --head unstable --base main --json number -q '.[0].number')
          gh pr merge "${PR_NUMBER}" --auto --merge
