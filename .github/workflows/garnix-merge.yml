name: Garnix Build and Merge

on:
  push:
    branches: [ unstable ]
  pull_request:
    branches: [ unstable ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [framework-desktop]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Nix with Garnix cache
      uses: DeterminateSystems/nix-installer-action@v13
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          substituters = https://cache.nixos.org/ https://cache.garnix.io
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=

    - name: Check flake syntax
      run: |
        cd ${{ matrix.host }}
        nix flake check --accept-flake-config

    - name: Build NixOS configuration via Garnix cache
      run: |
        cd ${{ matrix.host }}
        nix build .#nixosConfigurations.$(basename $(pwd) | sed 's/framework-desktop/perdurabo/') \
          --accept-flake-config \
          --option substituters "https://cache.nixos.org/ https://cache.garnix.io" \
          --option trusted-public-keys "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g="

    - name: Test development shells
      run: |
        cd ${{ matrix.host }}
        for shell in go python node rust devops; do
          echo "Testing $shell development shell..."
          nix develop .#$shell --command echo "$shell shell works"
        done

    - name: Run security checks
      run: |
        echo "Running basic security checks..."

        if grep -r -i "password.*=" --include="*.nix" . | grep -v "passwordFile\|hashedPassword\|config.age.secrets"; then
          echo "Found potential hardcoded passwords"
          exit 1
        fi

        if grep -r "permitRootLogin.*yes" --include="*.nix" .; then
          echo "Root login is enabled - ensure this is intentional"
        fi

        if grep -r "passwordAuthentication.*true" --include="*.nix" .; then
          echo "Password authentication is enabled - consider key-only auth"
        fi

        echo "Basic security checks passed"

  merge-to-main:
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/unstable' && github.event_name == 'push'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Merge unstable to main
      run: |
        git checkout main
        git merge --no-ff unstable -m "Merge unstable to main after successful Garnix build"
        git push origin main