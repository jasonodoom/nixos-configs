name: NixOS VM Tests
on:
  push:
    branches: [main, unstable]
  pull_request:
    branches: [main, unstable]
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  workflow_dispatch:      # Manual trigger

permissions:
  contents: read
  actions: write

jobs:
  vm-tests-nixos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - host: framework-desktop
            config: perdurabo
          - host: lenovo-thinkcentre-m710q
            config: congo

    steps:
      - uses: actions/checkout@v6

      - uses: DeterminateSystems/nix-installer-action@v21
        if: matrix.config == 'perdurabo'
        with:
          source-tag: "v3.12.1"
          extra-conf: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            extra-trusted-substituters = https://cache.garnix.io https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
            extra-trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - uses: DeterminateSystems/nix-installer-action@v21
        if: matrix.config == 'congo'
        with:
          source-tag: "v3.12.1"
          extra-conf: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            extra-trusted-substituters = https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
            extra-trusted-public-keys = odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Build system configuration
        id: system-build
        run: |
          cd ${{ matrix.host }}
          export NIX_CONFIG="accept-flake-config = true"
          set +e
          nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel --dry-run --show-trace --accept-flake-config 2>&1 | tee system-build-output.log
          SYSTEM_BUILD_EXIT_CODE=$?
          echo "SYSTEM_BUILD_EXIT_CODE=$SYSTEM_BUILD_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Run CLI access test
        id: cli-test
        run: |
          cd ${{ matrix.host }}
          export NIX_CONFIG="accept-flake-config = true"
          set +e
          nix build .#checks.x86_64-linux.cli-access --show-trace --accept-flake-config 2>&1 | tee cli-test-output.log
          CLI_EXIT_CODE=$?
          echo "CLI_EXIT_CODE=$CLI_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Run desktop switching test
        id: desktop-test
        if: matrix.host == 'framework-desktop'
        run: |
          cd framework-desktop
          export NIX_CONFIG="accept-flake-config = true"
          set +e
          nix build .#checks.x86_64-linux.desktop-switching --show-trace --accept-flake-config 2>&1 | tee desktop-test-output.log
          DESKTOP_EXIT_CODE=$?
          echo "DESKTOP_EXIT_CODE=$DESKTOP_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check test results
        id: check-results
        run: |
          TEST_FAILED=false

          if [ "${{ steps.system-build.outputs.SYSTEM_BUILD_EXIT_CODE }}" != "0" ]; then
            TEST_FAILED=true
            echo "System build failed"
          fi

          if [ "${{ steps.cli-test.outputs.CLI_EXIT_CODE }}" != "0" ]; then
            TEST_FAILED=true
            echo "CLI test failed"
          fi

          if [ "${{ matrix.host }}" == "framework-desktop" ] && [ "${{ steps.desktop-test.outputs.DESKTOP_EXIT_CODE }}" != "0" ]; then
            TEST_FAILED=true
            echo "Desktop test failed"
          fi

          cd ${{ matrix.host }}
          if grep -q "Traceback\|FAILED\|RequestedAssertionFailed" system-build-output.log cli-test-output.log desktop-test-output.log 2>/dev/null; then
            TEST_FAILED=true
            echo "Test failure patterns detected"
          fi

          if [ "$TEST_FAILED" = "false" ]; then
            echo "TEST_RESULT=success" >> $GITHUB_OUTPUT
            echo "[PASSED] All tests completed for ${{ matrix.config }}"
            exit 0
          else
            echo "TEST_RESULT=failure" >> $GITHUB_OUTPUT
            echo "[FAILED] Tests failed for ${{ matrix.config }}"
            exit 1
          fi

      - name: Generate screenshot summary
        if: always() && matrix.host == 'framework-desktop'
        run: |
          cd framework-desktop
          echo "## Test Screenshots - ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          found=0
          for img in result*/screenshots/*.png result*/*.png; do
            if [ -f "$img" ]; then
              found=1
              imgname=$(basename "$img")
              echo "### $imgname" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              size=$(du -h "$img" | cut -f1)
              echo "_Size: $size_" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              size_bytes=$(stat -c%s "$img" 2>/dev/null || stat -f%z "$img")
              if [ "$size_bytes" -lt 1048576 ]; then
                echo "![${imgname}](data:image/png;base64,$(base64 -w 0 "$img" 2>/dev/null || base64 "$img"))" >> $GITHUB_STEP_SUMMARY
              else
                echo "_Screenshot too large for inline display_" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ "$found" -eq 0 ]; then
            echo "No screenshots generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: test-artifacts-${{ matrix.config }}
          path: |
            ${{ matrix.host }}/*.log
            ${{ matrix.host }}/result*/screenshots/
            ${{ matrix.host }}/result*/*.png
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results - ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-results.outputs.TEST_RESULT }}" = "success" ]; then
            echo "[PASS] All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "[FAIL] Tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- CLI access: ${{ steps.cli-test.outputs.CLI_EXIT_CODE == '0' && '[PASS]' || '[FAIL]' }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ matrix.host }}" == "framework-desktop" ]; then
            echo "- Desktop switching: ${{ steps.desktop-test.outputs.DESKTOP_EXIT_CODE == '0' && '[PASS]' || '[FAIL]' }}" >> $GITHUB_STEP_SUMMARY
          fi

  vm-tests-darwin:
    runs-on: macos-14
    strategy:
      matrix:
        include:
          - host: apple-macbook-air-m2
            config: theophany
    steps:
      - uses: actions/checkout@v6

      - uses: DeterminateSystems/nix-installer-action@v21
        with:
          source-tag: "v3.12.1"
          extra-conf: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            extra-trusted-substituters = https://odoom-nixos-configs.cachix.org https://cache.flakehub.com https://install.determinate.systems https://nix-community.cachix.org https://cache.nixos.org/
            extra-trusted-public-keys = odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.flakehub.com-3:hJuILl5sVK4iKm86JzgdXW12Y2Hwd5G07qKtHTOcDCM= cache.flakehub.com-4:Asi8qIv291s0aYLyH6IOnr5Kf6+OF14WVjkE6t3xMio= cache.flakehub.com-5:zB96CRlL7tiPtzA9/WKyPkp3A2vqxqgdgyTVNGShPDU= cache.flakehub.com-6:W4EGFwAGgBj3he7c5fNh9NkOXw0PUVaxygCVKeuvaqU= cache.flakehub.com-7:mvxJ2DZVHn/kRxlIaxYNMuDG1OvMckZu32um1TadOR8= cache.flakehub.com-8:moO+OVS0mnTjBTcOUh2kYLQEd59ExzyoW1QgQ8XAARQ= cache.flakehub.com-9:wChaSeTI6TeCuV/Sg2513ZIM9i0qJaYsF+lZCXg0J6o= cache.flakehub.com-10:2GqeNlIp6AKp4EF2MVbE1kBOp9iBSyo0UPR9KoR0o1Y= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Run flake checks
        id: flake-check
        run: |
          cd ${{ matrix.host }}
          set +e
          nix flake check --show-trace --accept-flake-config 2>&1 | tee flake-check-output.log
          CHECK_EXIT_CODE=$?
          echo "CHECK_EXIT_CODE=$CHECK_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Build darwin configuration
        id: darwin-build
        run: |
          cd ${{ matrix.host }}
          set +e
          nix build .#darwinConfigurations.${{ matrix.config }}.system --show-trace --accept-flake-config 2>&1 | tee darwin-build-output.log
          BUILD_EXIT_CODE=$?
          echo "BUILD_EXIT_CODE=$BUILD_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check test results
        id: check-results
        run: |
          TEST_FAILED=false

          if [ "${{ steps.flake-check.outputs.CHECK_EXIT_CODE }}" != "0" ]; then
            TEST_FAILED=true
            echo "Flake check failed"
          fi

          if [ "${{ steps.darwin-build.outputs.BUILD_EXIT_CODE }}" != "0" ]; then
            TEST_FAILED=true
            echo "Darwin build failed"
          fi

          cd ${{ matrix.host }}
          if grep -q "error:\|failed\|FAILED" flake-check-output.log darwin-build-output.log 2>/dev/null; then
            TEST_FAILED=true
            echo "Test failure patterns detected"
          fi

          if [ "$TEST_FAILED" = "false" ]; then
            echo "TEST_RESULT=success" >> $GITHUB_OUTPUT
            echo "[PASSED] Darwin tests completed for ${{ matrix.config }}"
            exit 0
          else
            echo "TEST_RESULT=failure" >> $GITHUB_OUTPUT
            echo "[FAILED] Darwin tests failed for ${{ matrix.config }}"
            exit 1
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: test-artifacts-${{ matrix.config }}
          path: |
            ${{ matrix.host }}/*.log
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results - ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-results.outputs.TEST_RESULT }}" = "success" ]; then
            echo "[PASS] Darwin tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "[FAIL] Darwin tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Flake check: ${{ steps.flake-check.outputs.CHECK_EXIT_CODE == '0' && '[PASS]' || '[FAIL]' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ steps.darwin-build.outputs.BUILD_EXIT_CODE == '0' && '[PASS]' || '[FAIL]' }}" >> $GITHUB_STEP_SUMMARY

  desktop-screenshots:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v6

      - name: Free up disk space for desktop integration test
        run: |
          echo "Disk usage before cleanup:"
          df -h
          # Aggressive cleanup for desktop integration test
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /opt/microsoft
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/share/vcpkg
          sudo rm -rf /usr/local/share/cmake
          sudo rm -rf /opt/az
          sudo rm -rf /usr/share/gradle
          sudo docker image prune --all --force
          sudo docker system prune --all --force --volumes
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          sudo apt-get clean
          # Remove large language packs
          sudo rm -rf /usr/share/locale
          sudo rm -rf /usr/share/doc
          sudo rm -rf /usr/share/man
          echo "Disk usage after cleanup:"
          df -h

      - uses: cachix/install-nix-action@v31.9.1
        with:
          enable_kvm: false
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.garnix.io https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
            trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Run desktop integration test
        id: desktop-integration
        run: |
          cd framework-desktop
          export NIX_CONFIG="accept-flake-config = true"

          # Check disk space before build
          echo "Disk usage before desktop integration test:"
          df -h

          set +e
          nix build .#checks.x86_64-linux.desktop-integration \
            --show-trace \
            --accept-flake-config \
            --option max-jobs 1 \
            --option cores 2 \
            --option substitute true \
            --option builders-use-substitutes true \
            --option keep-going false \
            2>&1 | tee desktop-integration-output.log
          EXIT_CODE=$?
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Immediate cleanup after build attempt
          nix-collect-garbage --delete-older-than 1d
          nix store gc --max 1000000000  # Keep only 1GB in store

          echo "Disk usage after build and cleanup:"
          df -h

          if [ $EXIT_CODE -eq 0 ]; then
            echo "[PASS] Desktop integration test completed"
          else
            echo "[FAIL] Desktop integration test failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Generate screenshot summary
        if: always()
        run: |
          cd framework-desktop

          # Debug: Show what result directories exist
          echo "=== Debugging: Looking for screenshots ==="
          echo "Directory structure:"
          ls -laR result* 2>/dev/null || ls -la result 2>/dev/null || echo "No result directories found"
          echo ""
          echo "All PNG files found:"
          find . -name "*.png" -type f 2>/dev/null | while read f; do
            echo "  $f ($(du -h "$f" | cut -f1))"
          done || echo "No PNG files found"
          echo "========================================="

          echo "## Desktop Integration Screenshots" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          found=0
          # Look for screenshots in result directory (nixosTest output)
          for img in $(find result -name "*.png" -type f 2>/dev/null); do
            if [ -f "$img" ]; then
              found=1
              imgname=$(basename "$img")
              echo "### $imgname" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              size=$(du -h "$img" | cut -f1)
              echo "_Size: $size_" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              size_bytes=$(stat -c%s "$img" 2>/dev/null || stat -f%z "$img")
              if [ "$size_bytes" -lt 1048576 ]; then
                echo "![${imgname}](data:image/png;base64,$(base64 -w 0 "$img" 2>/dev/null || base64 "$img"))" >> $GITHUB_STEP_SUMMARY
              else
                echo "_Screenshot too large for inline display_" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ "$found" -eq 0 ]; then
            echo "No screenshots generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: desktop-integration-screenshots
          path: |
            framework-desktop/*.log
            framework-desktop/result/screenshots/*.png
            framework-desktop/result/*.png
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "## Desktop Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.desktop-integration.outputs.EXIT_CODE }}" = "0" ]; then
            echo "[PASS] Desktop integration test completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "[FAIL] Desktop integration test failed" >> $GITHUB_STEP_SUMMARY
            # Check the log for specific failures
            if grep -q "RequestedAssertionFailed\|Traceback\|timed out" framework-desktop/desktop-integration-output.log 2>/dev/null; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Error Details:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep -A 5 "RequestedAssertionFailed\|Traceback\|timed out" framework-desktop/desktop-integration-output.log | head -20 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests both GNOME and Hyprland configurations with screenshots" >> $GITHUB_STEP_SUMMARY
