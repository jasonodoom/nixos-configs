name: NixOS VM Tests
on:
  push:
    branches: [main, unstable]
  pull_request:
    branches: [main, unstable]

jobs:
  vm-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - host: framework-desktop
            config: perdurabo
          - host: lenovo-thinkcentre-m710q
            config: congo

    steps:
      - uses: actions/checkout@v5

      - uses: cachix/install-nix-action@v31.8.2
        with:
          enable_kvm: false
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.garnix.io https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
            trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Run CLI access test
        id: cli-test
        run: |
          cd ${{ matrix.host }}
          export NIX_CONFIG="accept-flake-config = true"
          set +e
          nix build .#checks.x86_64-linux.cli-access --show-trace --accept-flake-config 2>&1 | tee cli-test-output.log
          CLI_EXIT_CODE=$?
          echo "CLI_EXIT_CODE=$CLI_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Run desktop switching test
        id: desktop-test
        if: matrix.host == 'framework-desktop'
        run: |
          cd framework-desktop
          export NIX_CONFIG="accept-flake-config = true"
          set +e
          nix build .#checks.x86_64-linux.desktop-switching --show-trace --accept-flake-config 2>&1 | tee desktop-test-output.log
          DESKTOP_EXIT_CODE=$?
          echo "DESKTOP_EXIT_CODE=$DESKTOP_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check test results
        id: check-results
        run: |
          TEST_FAILED=false

          if [ "${{ steps.cli-test.outputs.CLI_EXIT_CODE }}" != "0" ]; then
            TEST_FAILED=true
            echo "CLI test failed"
          fi

          if [ "${{ matrix.host }}" == "framework-desktop" ] && [ "${{ steps.desktop-test.outputs.DESKTOP_EXIT_CODE }}" != "0" ]; then
            TEST_FAILED=true
            echo "Desktop test failed"
          fi

          cd ${{ matrix.host }}
          if grep -q "Traceback\|FAILED\|RequestedAssertionFailed" cli-test-output.log desktop-test-output.log 2>/dev/null; then
            TEST_FAILED=true
            echo "Test failure patterns detected"
          fi

          if [ "$TEST_FAILED" = "false" ]; then
            echo "TEST_RESULT=success" >> $GITHUB_OUTPUT
            echo "[PASSED] All tests completed for ${{ matrix.config }}"
            exit 0
          else
            echo "TEST_RESULT=failure" >> $GITHUB_OUTPUT
            echo "[FAILED] Tests failed for ${{ matrix.config }}"
            exit 1
          fi

      - name: Generate screenshot summary
        if: always() && matrix.host == 'framework-desktop'
        run: |
          cd framework-desktop
          echo "## Test Screenshots - ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          found=0
          for img in result*/screenshots/*.png result*/*.png; do
            if [ -f "$img" ]; then
              found=1
              imgname=$(basename "$img")
              echo "### $imgname" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              size=$(du -h "$img" | cut -f1)
              echo "_Size: $size_" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              size_bytes=$(stat -c%s "$img" 2>/dev/null || stat -f%z "$img")
              if [ "$size_bytes" -lt 1048576 ]; then
                echo "![${imgname}](data:image/png;base64,$(base64 -w 0 "$img" 2>/dev/null || base64 "$img"))" >> $GITHUB_STEP_SUMMARY
              else
                echo "_Screenshot too large for inline display_" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ "$found" -eq 0 ]; then
            echo "No screenshots generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-artifacts-${{ matrix.config }}
          path: |
            ${{ matrix.host }}/*.log
            ${{ matrix.host }}/result*/screenshots/
            ${{ matrix.host }}/result*/*.png
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results - ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-results.outputs.TEST_RESULT }}" = "success" ]; then
            echo "[PASS] All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "[FAIL] Tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- CLI access: ${{ steps.cli-test.outputs.CLI_EXIT_CODE == '0' && '[PASS]' || '[FAIL]' }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ matrix.host }}" == "framework-desktop" ]; then
            echo "- Desktop switching: ${{ steps.desktop-test.outputs.DESKTOP_EXIT_CODE == '0' && '[PASS]' || '[FAIL]' }}" >> $GITHUB_STEP_SUMMARY
          fi
