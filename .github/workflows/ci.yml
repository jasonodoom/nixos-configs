name: NixOS Configuration CI

# Cache strategy:
# - Perdurabo (framework-desktop): Uses Garnix cache (configured via garnix.yaml)
# - Congo (lenovo-thinkcentre-m710q): Uses Cachix (push from GitHub Actions)
#
# Why not use Garnix for both?
# Garnix only supports one flakeDir per repo and we maintain independent flakes
# per machine instead of a root flake. Cachix allows us to push from CI for Congo
# while Garnix continues to build and cache Perdurabo automatically.

on:
  push:
    branches: [ main, unstable ]
  pull_request:
    branches: [ main, unstable ]

jobs:
  build-with-cache:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - host: framework-desktop
            config: perdurabo
          - host: lenovo-thinkcentre-m710q
            config: congo

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Free up disk space
      run: |
        echo "Disk usage before cleanup:"
        df -h
        # Remove unnecessary packages and files
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /opt/microsoft
        sudo docker image prune --all --force
        sudo apt-get autoremove -y
        sudo apt-get autoclean
        echo "Disk usage after cleanup:"
        df -h

    - name: Install Nix with cache configuration
      uses: DeterminateSystems/nix-installer-action@v13
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          substituters = https://cache.garnix.io https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
          trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Setup Cachix for Congo builds
      if: matrix.config == 'congo'
      uses: cachix/cachix-action@v15
      with:
        name: odoom-nixos-configs

    - name: Run fast tests
      run: |
        cd ${{ matrix.host }}
        # Run CLI access test (both machines)
        echo "Running CLI access test..."
        nix build .#checks.x86_64-linux.cli-access --accept-flake-config

        # Run desktop-switching test (Perdurabo only, skip slow desktop-integration)
        if [ "${{ matrix.host }}" == "framework-desktop" ]; then
          echo "Running desktop-switching test..."
          nix build .#checks.x86_64-linux.desktop-switching --accept-flake-config
        fi

    - name: Build NixOS configuration
      run: |
        cd ${{ matrix.host }}
        # Perdurabo uses Garnix cache, Congo uses Cachix (setup above)
        nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel \
          --accept-flake-config \
          --option max-jobs 1 \
          --option cores 2 \
          --impure
        # Clean up after build to save space
        nix-collect-garbage
        echo "Disk usage after build:"
        df -h

    - name: Test development shells
      if: matrix.host == 'framework-desktop'
      run: |
        cd ${{ matrix.host }}
        # Test that all dev shells can be built
        for shell in go python node rust devops; do
          echo "Testing $shell development shell..."
          nix develop .#$shell --command echo "$shell shell works"
        done

    - name: Generate screenshot summary
      if: always() && matrix.host == 'framework-desktop'
      run: |
        cd ${{ matrix.host }}
        echo "## Test Screenshots" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Find all PNG screenshots
        found=0
        for img in result*/screenshots/*.png result*/*.png; do
          if [ -f "$img" ]; then
            found=1
            imgname=$(basename "$img")
            echo "### $imgname" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Get file size
            size=$(du -h "$img" | cut -f1)
            echo "_Size: $size_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Check if image is small enough for inline embedding (< 1MB)
            size_bytes=$(stat -c%s "$img" 2>/dev/null || stat -f%z "$img")
            if [ "$size_bytes" -lt 1048576 ]; then
              echo "![${imgname}](data:image/png;base64,$(base64 -w 0 "$img" 2>/dev/null || base64 "$img"))" >> $GITHUB_STEP_SUMMARY
            else
              echo "_Screenshot too large for inline display. Download artifacts to view._" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        done

        if [ "$found" -eq 0 ]; then
          echo "No screenshots generated by tests." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload test screenshots
      if: always() && matrix.host == 'framework-desktop'
      uses: actions/upload-artifact@v4
      with:
        name: perdurabo-test-screenshots
        path: |
          ${{ matrix.host }}/result*/screenshots/
          ${{ matrix.host }}/result*/*.png
        if-no-files-found: ignore

  format-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v13
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes

    - name: Check Nix formatting
      run: |
        # Check if nixfmt is available, otherwise skip
        if command -v nixfmt &> /dev/null; then
          find . -name "*.nix" -exec nixfmt --check {} \; || {
            echo "Nix files are not properly formatted"
            echo "Run 'nixfmt' on the files to fix formatting issues"
            exit 1
          }
        else
          echo "nixfmt not available, skipping format check"
        fi

  security-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Basic security audit
      run: |
        echo "Running basic security checks..."

        # Check for hardcoded passwords or secrets
        if grep -r -E "(password|secret|key|token)\s*=\s*\"[^\"]+\"" --include="*.nix" . | grep -v "passwordFile\|hashedPassword\|config.age.secrets\|PasswordAuthentication\|showPasswordVisibilityButton\|hidePasswordVisibilityButton\|signingkey\|token.*=.*\"token\""; then
          echo "Found potential hardcoded passwords"
          exit 1
        fi

        # Check for common misconfigurations
        if grep -r "permitRootLogin.*yes" --include="*.nix" .; then
          echo "Root login is enabled - ensure this is intentional"
        fi

        if grep -r "passwordAuthentication.*true" --include="*.nix" .; then
          echo "Password authentication is enabled - consider key-only auth"
        fi

        echo "Basic security checks passed"