name: NixOS Configuration CI with Garnix

on:
  push:
    branches: [ main, unstable ]
  pull_request:
    branches: [ main, unstable ]

jobs:
  build-with-garnix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [framework-desktop]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Free up disk space
      run: |
        echo "Disk usage before cleanup:"
        df -h
        # Remove unnecessary packages and files
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /opt/microsoft
        sudo docker image prune --all --force
        sudo apt-get autoremove -y
        sudo apt-get autoclean
        echo "Disk usage after cleanup:"
        df -h

    - name: Install Nix with Garnix cache
      uses: DeterminateSystems/nix-installer-action@v13
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          substituters = https://cache.garnix.io https://cache.nixos.org/
          trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Check flake syntax
      run: |
        cd ${{ matrix.host }}
        nix flake check --accept-flake-config

    - name: Build NixOS configuration via Garnix cache
      run: |
        cd ${{ matrix.host }}
        # Use Garnix cache for faster builds
        nix build .#nixosConfigurations.perdurabo.config.system.build.toplevel \
          --accept-flake-config \
          --option substituters "https://cache.garnix.io https://cache.nixos.org/" \
          --option trusted-public-keys "cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=" \
          --option max-jobs 1 \
          --option cores 2
        # Clean up after build to save space
        nix-collect-garbage
        echo "Disk usage after build:"
        df -h

    - name: Test development shells
      run: |
        cd ${{ matrix.host }}
        # Test that all dev shells can be built
        for shell in go python node rust devops; do
          echo "Testing $shell development shell..."
          nix develop .#$shell --command echo "$shell shell works"
        done

  format-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v13
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes

    - name: Check Nix formatting
      run: |
        # Check if nixfmt is available, otherwise skip
        if command -v nixfmt &> /dev/null; then
          find . -name "*.nix" -exec nixfmt --check {} \; || {
            echo "Nix files are not properly formatted"
            echo "Run 'nixfmt' on the files to fix formatting issues"
            exit 1
          }
        else
          echo "nixfmt not available, skipping format check"
        fi

  security-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Basic security audit
      run: |
        echo "Running basic security checks..."

        # Check for hardcoded passwords or secrets
        if grep -r -E "(password|secret|key|token)\s*=\s*\"[^\"]+\"" --include="*.nix" . | grep -v "passwordFile\|hashedPassword\|config.age.secrets\|PasswordAuthentication\|showPasswordVisibilityButton\|hidePasswordVisibilityButton\|signingkey\|token.*=.*\"token\""; then
          echo "Found potential hardcoded passwords"
          exit 1
        fi

        # Check for common misconfigurations
        if grep -r "permitRootLogin.*yes" --include="*.nix" .; then
          echo "Root login is enabled - ensure this is intentional"
        fi

        if grep -r "passwordAuthentication.*true" --include="*.nix" .; then
          echo "Password authentication is enabled - consider key-only auth"
        fi

        echo "Basic security checks passed"