name: NixOS Configuration CI

# Cache strategy:
# - Perdurabo (framework-desktop): Uses Garnix cache (configured via garnix.yaml)
# - Congo (lenovo-thinkcentre-m710q): Uses Cachix (push from GitHub Actions)
#
# Why not use Garnix for both?
# Garnix only supports one flakeDir per repo and we maintain independent flakes
# per machine instead of a root flake. Cachix allows us to push from CI for Congo
# while Garnix continues to build and cache Perdurabo automatically.

on:
  push:
    branches: [ main, unstable ]
  pull_request:
    branches: [ main, unstable ]

jobs:
  build-with-cache:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1  # Run builds sequentially to avoid resource contention
      matrix:
        include:
          - host: lenovo-thinkcentre-m710q
            config: congo
          - host: framework-desktop
            config: perdurabo

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Free up disk space
      run: |
        echo "Disk usage before cleanup:"
        df -h
        # More aggressive cleanup for framework-desktop builds
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /opt/microsoft
        sudo rm -rf /usr/share/swift
        sudo rm -rf /usr/local/share/vcpkg
        sudo rm -rf /usr/local/share/cmake
        sudo rm -rf /opt/az
        sudo rm -rf /usr/share/gradle
        sudo docker image prune --all --force
        sudo docker system prune --all --force --volumes
        sudo apt-get autoremove -y
        sudo apt-get autoclean
        sudo apt-get clean
        # Remove large language packs
        sudo rm -rf /usr/share/locale
        sudo rm -rf /usr/share/doc
        sudo rm -rf /usr/share/man
        echo "Disk usage after cleanup:"
        df -h

    - name: Install Nix with cache configuration
      uses: DeterminateSystems/nix-installer-action@v21
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          substituters = https://cache.garnix.io https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
          trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Setup Cachix for Congo builds
      if: matrix.config == 'congo'
      uses: cachix/cachix-action@v16
      with:
        name: odoom-nixos-configs
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

    - name: Check flake syntax
      run: |
        cd ${{ matrix.host }}
        nix flake check --accept-flake-config --no-build

    - name: Build NixOS configuration
      run: |
        cd ${{ matrix.host }}

        # Check disk space before build
        echo "Disk usage before build:"
        df -h

        # Intermediate cleanup for framework-desktop (large build)
        if [ "${{ matrix.config }}" == "perdurabo" ]; then
          echo "Framework desktop build - applying stricter resource limits"
          # More restrictive resource limits for large builds
          MAX_JOBS=1
          CORES=1
        else
          MAX_JOBS=1
          CORES=2
        fi

        # Build with resource limits and cache optimization
        nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel \
          --accept-flake-config \
          --option max-jobs $MAX_JOBS \
          --option cores $CORES \
          --option keep-going false \
          --option substitute true \
          --option builders-use-substitutes true \
          --impure

        # Immediate cleanup after build
        nix-collect-garbage --delete-older-than 1d
        nix store gc --max 1000000000  # Keep only 1GB in store

        echo "Disk usage after build and cleanup:"
        df -h

    - name: Test development shells
      if: matrix.host == 'framework-desktop'
      run: |
        cd ${{ matrix.host }}
        # Test that all dev shells can be built
        for shell in go python node rust devops; do
          echo "Testing $shell development shell..."
          nix develop .#$shell --command echo "$shell shell works"
        done

  format-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v21
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes

    - name: Check Nix formatting
      run: |
        # Check if nixfmt is available, otherwise skip
        if command -v nixfmt &> /dev/null; then
          find . -name "*.nix" -exec nixfmt --check {} \; || {
            echo "Nix files are not properly formatted"
            echo "Run 'nixfmt' on the files to fix formatting issues"
            exit 1
          }
        else
          echo "nixfmt not available, skipping format check"
        fi

  security-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Basic security audit
      run: |
        echo "Running basic security checks..."

        # Check for hardcoded passwords or secrets
        if grep -r -E "(password|secret|key|token)\s*=\s*\"[^\"]+\"" --include="*.nix" . | grep -v "passwordFile\|hashedPassword\|config.age.secrets\|PasswordAuthentication\|showPasswordVisibilityButton\|hidePasswordVisibilityButton\|signingkey\|token.*=.*\"token\""; then
          echo "Found potential hardcoded passwords"
          exit 1
        fi

        # Check for common misconfigurations
        if grep -r "permitRootLogin.*yes" --include="*.nix" .; then
          echo "Root login is enabled - ensure this is intentional"
        fi

        if grep -r "passwordAuthentication.*true" --include="*.nix" .; then
          echo "Password authentication is enabled - consider key-only auth"
        fi

        echo "Basic security checks passed"