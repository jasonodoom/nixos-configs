name: NixOS Configuration CI

# Cache strategy:
# - Perdurabo: Pushes to Garnix (automatic via garnix.yaml), pulls from garnix + cachix + nixos.org
# - Congo: Pushes to Cachix, pulls from cachix + nixos.org
# - Theophany: Pushes to Cachix, pulls from cachix + other configured caches

on:
  push:
    branches: [ main, unstable ]
  pull_request:
    branches: [ main, unstable ]

jobs:
  build-with-cache:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        include:
          - host: lenovo-thinkcentre-m710q
            config: congo
            os: ubuntu-latest
          - host: framework-desktop
            config: perdurabo
            os: ubuntu-latest
          - host: apple-macbook-air-m2
            config: theophany
            os: macos-14

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Free up disk space
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "Disk usage before cleanup:"
        df -h
        # More aggressive cleanup for framework-desktop builds
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /opt/microsoft
        sudo rm -rf /usr/share/swift
        sudo rm -rf /usr/local/share/vcpkg
        sudo rm -rf /usr/local/share/cmake
        sudo rm -rf /opt/az
        sudo rm -rf /usr/share/gradle
        sudo docker image prune --all --force
        sudo docker system prune --all --force --volumes
        sudo apt-get autoremove -y
        sudo apt-get autoclean
        sudo apt-get clean
        # Remove large language packs
        sudo rm -rf /usr/share/locale
        sudo rm -rf /usr/share/doc
        sudo rm -rf /usr/share/man
        echo "Disk usage after cleanup:"
        df -h

    - name: Install Nix with cache configuration (Perdurabo)
      if: matrix.config == 'perdurabo'
      uses: DeterminateSystems/nix-installer-action@v21
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          substituters = https://cache.garnix.io https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
          trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Install Nix with cache configuration (Congo)
      if: matrix.config == 'congo'
      uses: DeterminateSystems/nix-installer-action@v21
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          substituters = https://odoom-nixos-configs.cachix.org https://cache.nixos.org/
          trusted-public-keys = odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Install Nix with cache configuration (macOS)
      if: matrix.os == 'macos-14'
      uses: DeterminateSystems/nix-installer-action@v21
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          extra-trusted-substituters = https://odoom-nixos-configs.cachix.org https://cache.flakehub.com https://install.determinate.systems https://nix-community.cachix.org https://cache.nixos.org/
          extra-trusted-public-keys = odoom-nixos-configs.cachix.org-1:ySk5iYiHKvbuE1FezCjusvvFR98rkXDLMM6bS8SH3SU= cache.flakehub.com-3:hJuILl5sVK4iKm86JzgdXW12Y2Hwd5G07qKtHTOcDCM= cache.flakehub.com-4:Asi8qIv291s0aYLyH6IOnr5Kf6+OF14WVjkE6t3xMio= cache.flakehub.com-5:zB96CRlL7tiPtzA9/WKyPkp3A2vqxqgdgyTVNGShPDU= cache.flakehub.com-6:W4EGFwAGgBj3he7c5fNh9NkOXw0PUVaxygCVKeuvaqU= cache.flakehub.com-7:mvxJ2DZVHn/kRxlIaxYNMuDG1OvMckZu32um1TadOR8= cache.flakehub.com-8:moO+OVS0mnTjBTcOUh2kYLQEd59ExzyoW1QgQ8XAARQ= cache.flakehub.com-9:wChaSeTI6TeCuV/Sg2513ZIM9i0qJaYsF+lZCXg0J6o= cache.flakehub.com-10:2GqeNlIp6AKp4EF2MVbE1kBOp9iBSyo0UPR9KoR0o1Y= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Setup Cachix
      if: matrix.config != 'perdurabo'
      uses: cachix/cachix-action@v16
      with:
        name: odoom-nixos-configs
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

    - name: Check flake health
      uses: DeterminateSystems/flake-checker-action@v9
      with:
        flake-lock-path: ${{ matrix.host }}/flake.lock

    - name: Check flake syntax
      run: |
        cd ${{ matrix.host }}
        nix flake check --accept-flake-config --no-build

    - name: Build NixOS configuration
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd ${{ matrix.host }}

        # Check disk space before build
        echo "Disk usage before build:"
        df -h

        # Intermediate cleanup for framework-desktop (large build)
        if [ "${{ matrix.config }}" == "perdurabo" ]; then
          echo "Framework desktop build - applying stricter resource limits"
          # More restrictive resource limits for large builds
          MAX_JOBS=1
          CORES=1
        else
          MAX_JOBS=1
          CORES=2
        fi

        # Build with resource limits and cache optimization
        nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel \
          --accept-flake-config \
          --option max-jobs $MAX_JOBS \
          --option cores $CORES \
          --option keep-going false \
          --option substitute true \
          --option builders-use-substitutes true \
          --impure

        # Immediate cleanup after build
        nix-collect-garbage --delete-older-than 1d
        nix store gc --max 1000000000  # Keep only 1GB in store

        echo "Disk usage after build and cleanup:"
        df -h

    - name: Build nix-darwin configuration
      if: matrix.os == 'macos-14'
      run: |
        cd ${{ matrix.host }}

        # Build darwin configuration
        nix build .#darwinConfigurations.${{ matrix.config }}.system \
          --accept-flake-config \
          --option substitute true \
          --option builders-use-substitutes true

    - name: Test development shells
      if: matrix.host == 'framework-desktop'
      run: |
        cd ${{ matrix.host }}
        # Test that all dev shells can be built
        for shell in go python node rust devops; do
          echo "Testing $shell development shell..."
          nix develop .#$shell --command echo "$shell shell works"
        done

    - name: Test Congo server configuration
      if: matrix.host == 'lenovo-thinkcentre-m710q'
      run: |
        cd ${{ matrix.host }}

        echo "=== Container Configuration Validation ==="
        # Verify container configs are syntactically valid and have required settings
        for container in pihole openbao homepage; do
          echo "Checking $container container configuration..."
          nix eval .#nixosConfigurations.congo.config.containers.$container.autoStart --json | jq -e '. == true' && echo "  ✓ $container autoStart enabled" || echo "  ✗ $container autoStart missing"
          nix eval .#nixosConfigurations.congo.config.containers.$container.privateNetwork --json | jq -e '. == true' && echo "  ✓ $container privateNetwork enabled" || echo "  ✗ $container privateNetwork missing"
          nix eval .#nixosConfigurations.congo.config.containers.$container.localAddress --json && echo "  ✓ $container has IP address" || echo "  ✗ $container IP missing"
        done

        echo ""
        echo "=== Service Activation Tests ==="
        # Check that critical services are defined and enabled
        echo "Checking SSH service..."
        nix eval .#nixosConfigurations.congo.config.services.openssh.enable --json | jq -e '. == true' && echo "  ✓ SSH enabled" || echo "  ✗ SSH not enabled"

        echo "Checking Tailscale service..."
        nix eval .#nixosConfigurations.congo.config.services.tailscale.enable --json | jq -e '. == true' && echo "  ✓ Tailscale enabled" || echo "  ✗ Tailscale not enabled"

        echo "Checking fail2ban service..."
        nix eval .#nixosConfigurations.congo.config.services.fail2ban.enable --json | jq -e '. == true' && echo "  ✓ fail2ban enabled" || echo "  ✗ fail2ban not enabled"

        echo ""
        echo "=== Network Configuration Validation ==="
        # Verify network settings
        echo "Checking hostname..."
        nix eval .#nixosConfigurations.congo.config.networking.hostName --json | jq -r '.' | grep -q "congo" && echo "  ✓ Hostname is congo" || echo "  ✗ Hostname incorrect"

        echo "Checking firewall..."
        nix eval .#nixosConfigurations.congo.config.networking.firewall.enable --json | jq -e '. == true' && echo "  ✓ Firewall enabled" || echo "  ✗ Firewall not enabled"

        echo "Checking SSH port..."
        nix eval .#nixosConfigurations.congo.config.services.openssh.ports --json | jq -e 'length > 0' && echo "  ✓ SSH ports configured" || echo "  ✗ SSH ports not configured"

        echo "Checking Tailscale interface..."
        nix eval .#nixosConfigurations.congo.config.services.tailscale.interfaceName --json | jq -r '.' && echo "  ✓ Tailscale interface configured" || echo "  ✗ Tailscale interface missing"

        echo ""
        echo "=== All Congo server tests completed ==="

  format-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v21
      with:
        source-tag: "v3.12.1"
        extra-conf: |
          experimental-features = nix-command flakes

    - name: Check Nix formatting
      run: |
        # Check if nixfmt is available, otherwise skip
        if command -v nixfmt &> /dev/null; then
          find . -name "*.nix" -exec nixfmt --check {} \; || {
            echo "Nix files are not properly formatted"
            echo "Run 'nixfmt' on the files to fix formatting issues"
            exit 1
          }
        else
          echo "nixfmt not available, skipping format check"
        fi

  security-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Basic security audit
      run: |
        echo "Running basic security checks..."

        # Check for private keys (should never be in repo)
        if grep -r "BEGIN.*PRIVATE KEY" --include="*.nix" .; then
          echo "Found private keys in repository - this is a security risk!"
          exit 1
        fi

        # Check for hardcoded passwords or secrets (excluding SSH public keys)
        if grep -r -E "(password|secret|key|token)\s*=\s*\"[^\"]+\"" --include="*.nix" . | grep -v "passwordFile\|hashedPassword\|config.age.secrets\|PasswordAuthentication\|showPasswordVisibilityButton\|hidePasswordVisibilityButton\|signingkey\|token.*=.*\"token\"\|ssh-ed25519\|ssh-rsa"; then
          echo "Found potential hardcoded passwords"
          exit 1
        fi

        # Check for common misconfigurations
        if grep -r "permitRootLogin.*yes" --include="*.nix" .; then
          echo "Root login is enabled - ensure this is intentional"
        fi

        if grep -r "passwordAuthentication.*true" --include="*.nix" .; then
          echo "Password authentication is enabled - consider key-only auth"
        fi

        echo "Basic security checks passed"