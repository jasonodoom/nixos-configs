name: Deploy Screenshots to Pages

on:
  workflow_run:
    workflows: ["NixOS VM Tests"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: desktop-integration-screenshots
          path: screenshots
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Check if screenshots exist
        id: check-screenshots
        run: |
          if [ -d "screenshots" ] && [ "$(find screenshots -name '*.png' -o -name '*.jpg' | wc -l)" -gt 0 ]; then
            echo "has_screenshots=true" >> $GITHUB_OUTPUT
          else
            echo "has_screenshots=false" >> $GITHUB_OUTPUT
            echo "No screenshots found, skipping Pages deployment"
          fi

      - name: Generate gallery
        if: steps.check-screenshots.outputs.has_screenshots == 'true'
        run: |
          cd screenshots
          cat > index.html << 'HTML'
          <!DOCTYPE html>
          <html>
          <head>
              <title>NixOS Test Screenshots</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
                  .container { max-width: 1400px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #333; border-bottom: 3px solid #7aa2f7; padding-bottom: 10px; }
                  .timestamp { color: #666; font-size: 0.9em; margin-bottom: 30px; }
                  .screenshot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0; }
                  .screenshot-item { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; transition: transform 0.2s; }
                  .screenshot-item:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
                  .screenshot-item h3 { margin-top: 0; color: #7aa2f7; font-size: 1.1em; }
                  .screenshot-item img { width: 100%; border-radius: 4px; cursor: pointer; }
                  .screenshot-item img:hover { opacity: 0.8; }
                  .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>NixOS Test Screenshots</h1>
                  <div class="timestamp">Generated: $(date)</div>
                  <div class="screenshot-grid">
          HTML

          find . -type f \( -name "*.png" -o -name "*.jpg" \) | sort | while read img; do
            if [ -f "$img" ]; then
              imgname=$(basename "$img")
              imgpath="${img#./}"
              cat >> index.html << HTML
                      <div class="screenshot-item">
                          <h3>$imgname</h3>
                          <a href="$imgpath" target="_blank">
                              <img src="$imgpath" alt="$imgname" loading="lazy">
                          </a>
                      </div>
          HTML
            fi
          done

          cat >> index.html << 'HTML'
                  </div>
                  <div class="footer">
                      <p>NixOS Configuration Tests - Perdurabo & Congo</p>
                      <p><a href="https://github.com/jasonodoom/nixos-configs">GitHub Repository</a></p>
                  </div>
              </div>
          </body>
          </html>
          HTML

      - name: Setup Pages
        if: steps.check-screenshots.outputs.has_screenshots == 'true'
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: steps.check-screenshots.outputs.has_screenshots == 'true'
        uses: actions/upload-pages-artifact@v4
        with:
          path: screenshots

      - name: Deploy to GitHub Pages
        if: steps.check-screenshots.outputs.has_screenshots == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
