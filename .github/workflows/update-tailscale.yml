name: Update Tailscale

on:
  schedule:
    # 8 AM, 2 PM, 8 PM UTC
    - cron: '0 8,14,20 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-tailscale:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Keep Tailscale workflow targeting main so security updates aren't blocked
          ref: main

      - name: Maximize build space for Nix
        uses: wimpysworld/nothing-but-nix@main

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
        with:
          source-tag: "v3.12.1"
          extra-conf: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Get latest Tailscale release
        id: tailscale-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use gh CLI with authentication to avoid rate limits
          RELEASE_DATA=$(gh api repos/tailscale/tailscale/releases/latest)
          LATEST_VERSION=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          CHANGELOG=$(echo "$RELEASE_DATA" | jq -r '.body')
          SECURITY_CHECK=$(echo "$CHANGELOG" | grep -iE "security|cve|vulnerability|exploit" || echo "")

          echo "version=${LATEST_VERSION}" >> $GITHUB_OUTPUT
          echo "Latest Tailscale version: ${LATEST_VERSION}"

          # Save changelog using multiline output
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Check for security-related release
          if [ -n "$SECURITY_CHECK" ]; then
            echo "security=true" >> $GITHUB_OUTPUT
            echo "[SECURITY] Security update detected"
          else
            echo "security=false" >> $GITHUB_OUTPUT
          fi

      - name: Check current version in flakes
        id: current-version
        run: |
          PERDURABO_VERSION=$(grep -oP 'url = "github:tailscale/tailscale/\K[^"]+' framework-desktop/flake.nix || echo "none")
          echo "version=${PERDURABO_VERSION}" >> $GITHUB_OUTPUT
          echo "Perdurabo version: ${PERDURABO_VERSION}"

      - name: Check if update needed
        id: check-update
        run: |
          if [ "${{ steps.tailscale-release.outputs.version }}" != "${{ steps.current-version.outputs.version }}" ]; then
            echo "Update needed from ${{ steps.current-version.outputs.version }} to ${{ steps.tailscale-release.outputs.version }}"
            echo "needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already on latest version ${{ steps.current-version.outputs.version }}"
            echo "needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR already exists
        if: steps.check-update.outputs.needed == 'true'
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.TAILSCALE_UPDATE_TOKEN }}
        run: |
          BRANCH_NAME="update-tailscale-${{ steps.tailscale-release.outputs.version }}"
          # Check if an open PR already exists for this version
          EXISTING_PR=$(gh pr list --head "${BRANCH_NAME}" --state open --json number -q '.[0].number' || echo "")
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #${EXISTING_PR} already exists for ${BRANCH_NAME}, skipping"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found for ${BRANCH_NAME}"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create update branch
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        run: |
          BRANCH_NAME="update-tailscale-${{ steps.tailscale-release.outputs.version }}"
          # Fetch remote branches
          git fetch origin
          # Check if branch exists remotely and delete it (stale from failed run)
          if git ls-remote --heads origin "${BRANCH_NAME}" | grep -q "${BRANCH_NAME}"; then
            echo "Deleting stale remote branch ${BRANCH_NAME}"
            git push origin --delete "${BRANCH_NAME}" || true
          fi
          git checkout -b "${BRANCH_NAME}"
          echo "branch=${BRANCH_NAME}" >> $GITHUB_ENV

      - name: Update flake.nix files with new version
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        run: |
          # Update framework-desktop (Perdurabo)
          sed -i 's|url = "github:tailscale/tailscale/[^"]*"|url = "github:tailscale/tailscale/${{ steps.tailscale-release.outputs.version }}"|g' framework-desktop/flake.nix
          git diff framework-desktop/flake.nix

          # Update lenovo-thinkcentre-m710q (Congo)
          sed -i 's|url = "github:tailscale/tailscale/[^"]*"|url = "github:tailscale/tailscale/${{ steps.tailscale-release.outputs.version }}"|g' lenovo-thinkcentre-m710q/flake.nix
          git diff lenovo-thinkcentre-m710q/flake.nix

      - name: Update flake locks
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        run: |
          cd framework-desktop
          nix flake update tailscale --accept-flake-config

          cd ../lenovo-thinkcentre-m710q
          nix flake update tailscale --accept-flake-config

      - name: Build Perdurabo configuration
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        run: |
          cd framework-desktop
          nix build .#nixosConfigurations.perdurabo.config.system.build.toplevel \
            --accept-flake-config \
            --show-trace \
            --max-jobs 1 \
            --cores 1

      - name: Clean up after Perdurabo build
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        run: |
          nix-collect-garbage -d
          nix store gc
          df -h

      - name: Build Congo configuration
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        run: |
          cd lenovo-thinkcentre-m710q
          nix build .#nixosConfigurations.congo.config.system.build.toplevel \
            --accept-flake-config \
            --show-trace \
            --max-jobs 1 \
            --cores 1

      - name: Commit and push changes
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "Update Tailscale to ${{ steps.tailscale-release.outputs.version }}"
          branch: ${{ env.branch }}
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          file_pattern: 'framework-desktop/flake.nix framework-desktop/flake.lock lenovo-thinkcentre-m710q/flake.nix lenovo-thinkcentre-m710q/flake.lock'

      - name: Create Pull Request
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.TAILSCALE_UPDATE_TOKEN }}
        run: |
          SECURITY_LABEL=""
          SECURITY_WARNING=""
          TITLE_PREFIX=""
          if [ "${{ steps.tailscale-release.outputs.security }}" == "true" ]; then
            SECURITY_LABEL="--label security"
            TITLE_PREFIX="[SECURITY] "
            SECURITY_WARNING="## [SECURITY UPDATE]
          This release contains security-related fixes. Review and merge promptly.

          "
          fi

          PR_URL=$(gh pr create \
            --title "${TITLE_PREFIX}Update Tailscale to ${{ steps.tailscale-release.outputs.version }}" \
            --body "${SECURITY_WARNING}Automated update of Tailscale from ${{ steps.current-version.outputs.version }} to ${{ steps.tailscale-release.outputs.version }}.

          ## Changes
          - Updated Tailscale flake input to ${{ steps.tailscale-release.outputs.version }} for both Perdurabo and Congo
          - Ran \`nix flake update tailscale\` in framework-desktop and lenovo-thinkcentre-m710q
          - Build tests passed for both configurations

          ## Release Notes
          ${{ steps.tailscale-release.outputs.changelog }}

          ---
          This PR was automatically created by the [update-tailscale workflow](https://github.com/${{ github.repository }}/blob/main/.github/workflows/update-tailscale.yml) and will auto-merge after approval." \
            --base main \
            --head "${branch}" \
            --label "dependencies" \
            --label "automated" \
            $SECURITY_LABEL \
            --assignee jasonodoom \
            --reviewer jasonodoom)

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT

      - name: Enable auto-merge
        if: steps.check-update.outputs.needed == 'true' && steps.check-pr.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.TAILSCALE_UPDATE_TOKEN }}
        run: |
          # Wait for PR to be created
          sleep 2
          PR_NUMBER=$(gh pr view "${branch}" --json number -q .number)
          gh pr merge "${PR_NUMBER}" --auto --squash -d

      - name: Notify on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.TAILSCALE_UPDATE_TOKEN }}
        run: |
          gh issue create \
            --title "[FAIL] Tailscale update workflow failed" \
            --body "The automated Tailscale update workflow failed.

          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Attempted version:** ${{ steps.tailscale-release.outputs.version }}
          **Current version:** ${{ steps.current-version.outputs.version }}

          Please investigate the failure and update manually if needed." \
            --assignee jasonodoom \
            --label "bug" \
            --label "automated"
