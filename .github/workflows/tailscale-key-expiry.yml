name: Check Tailscale Auth Key Expiry

on:
  schedule:
    # Check weekly on Monday at 9 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  check-expiry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check auth key expiry date
        id: check
        run: |
          # Read expiry dates from both Congo and Perdurabo secrets.nix
          CONGO_EXPIRY=$(grep -A1 "tailscale-initrd-key" lenovo-thinkcentre-m710q/secrets/secrets.nix | grep -oP "Expires: \K\d{4}-\d{2}-\d{2}" || echo "")
          PERDURABO_EXPIRY=$(grep -A1 "tailscale-initrd-key" framework-desktop/secrets/secrets.nix | grep -oP "Expires: \K\d{4}-\d{2}-\d{2}" || echo "")

          # Find the earliest expiring key
          EXPIRY_DATE=""
          HOST=""

          if [ -n "$CONGO_EXPIRY" ] && [ -n "$PERDURABO_EXPIRY" ]; then
            CONGO_EPOCH=$(date -d "$CONGO_EXPIRY" +%s)
            PERDURABO_EPOCH=$(date -d "$PERDURABO_EXPIRY" +%s)
            if [ $CONGO_EPOCH -lt $PERDURABO_EPOCH ]; then
              EXPIRY_DATE="$CONGO_EXPIRY"
              HOST="Congo"
            else
              EXPIRY_DATE="$PERDURABO_EXPIRY"
              HOST="Perdurabo"
            fi
          elif [ -n "$CONGO_EXPIRY" ]; then
            EXPIRY_DATE="$CONGO_EXPIRY"
            HOST="Congo"
          elif [ -n "$PERDURABO_EXPIRY" ]; then
            EXPIRY_DATE="$PERDURABO_EXPIRY"
            HOST="Perdurabo"
          fi

          if [ -z "$EXPIRY_DATE" ]; then
            echo "No expiry date found in secrets.nix files"
            exit 0
          fi

          EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
          TODAY_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $TODAY_EPOCH) / 86400 ))

          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
          echo "expiry_date=$EXPIRY_DATE" >> $GITHUB_OUTPUT
          echo "host=$HOST" >> $GITHUB_OUTPUT
          echo "congo_expiry=$CONGO_EXPIRY" >> $GITHUB_OUTPUT
          echo "perdurabo_expiry=$PERDURABO_EXPIRY" >> $GITHUB_OUTPUT

          if [ $DAYS_LEFT -le 7 ]; then
            echo "warning=true" >> $GITHUB_OUTPUT
          else
            echo "warning=false" >> $GITHUB_OUTPUT
          fi

          # Check if this is a follow-up (3 days before)
          if [ $DAYS_LEFT -le 3 ]; then
            echo "followup=true" >> $GITHUB_OUTPUT
          else
            echo "followup=false" >> $GITHUB_OUTPUT
          fi

      - name: Create reminder issue
        if: steps.check.outputs.warning == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const daysLeft = ${{ steps.check.outputs.days_left }};
            const expiryDate = '${{ steps.check.outputs.expiry_date }}';
            const host = '${{ steps.check.outputs.host }}';
            const congoExpiry = '${{ steps.check.outputs.congo_expiry }}';
            const perduraboExpiry = '${{ steps.check.outputs.perdurabo_expiry }}';

            const title = `[URGENT] Tailscale initrd auth key expires in ${daysLeft} days`;

            let expiryInfo = '';
            if (congoExpiry && perduraboExpiry) {
              expiryInfo = `
            **Congo:** ${congoExpiry}
            **Perdurabo:** ${perduraboExpiry}

            Next to expire: **${host}** on **${expiryDate}** (${daysLeft} days)`;
            } else {
              expiryInfo = `The Tailscale auth key for ${host} initrd will expire on **${expiryDate}** (${daysLeft} days).`;
            }

            const body = `## Tailscale Auth Key Expiring Soon

            ${expiryInfo}

            > This key will expire on ${expiryDate}. If you'll then want to continue using an auth key, you'll need to generate a new one.

            ### Action Required:

            1. Generate a new reusable auth key at https://login.tailscale.com/admin/settings/keys
               - Reusable: ✓
               - Ephemeral: ✓ (removes device when initrd stops)
               - Pre-authorized: ✓
               - Expiry: 90 days

            2. If Tailnet Lock is enabled, pre-sign the key:
               \`\`\`bash
               export AUTH_KEY="tskey-auth-YOUR-KEY-HERE"
               tailscale lock sign "$AUTH_KEY"
               \`\`\`

            3. For **Congo**:
               \`\`\`bash
               cd /etc/nixos/lenovo-thinkcentre-m710q
               RULES=secrets/secrets.nix ragenix -e secrets/tailscale-initrd-key.age
               # Paste the pre-signed key when prompted
               # Update expiry date in lenovo-thinkcentre-m710q/secrets/secrets.nix
               age --decrypt -i ~/.ssh/id_ed25519 secrets/tailscale-initrd-key.age | doas tee /etc/secrets/initrd/tailscale-auth-key
               doas chmod 400 /etc/secrets/initrd/tailscale-auth-key
               doas nixos-rebuild switch --flake .#congo
               \`\`\`

            4. For **Perdurabo**:
               \`\`\`bash
               cd /etc/nixos/framework-desktop
               RULES=secrets/secrets.nix ragenix -e secrets/tailscale-initrd-key.age
               # Paste the pre-signed key when prompted
               # Update expiry date in framework-desktop/secrets/secrets.nix
               age --decrypt -i ~/.ssh/id_ed25519 secrets/tailscale-initrd-key.age | sudo tee /etc/secrets/initrd/tailscale-auth-key
               sudo chmod 400 /etc/secrets/initrd/tailscale-auth-key
               sudo nixos-rebuild switch --flake .#perdurabo
               \`\`\`

            @jasonodoom`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'tailscale,security'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Tailscale initrd auth key')
            );

            const isFollowup = '${{ steps.check.outputs.followup }}' === 'true';

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['tailscale', 'security', 'reminder'],
                assignees: ['jasonodoom']
              });
            } else if (isFollowup && existingIssue.state === 'open') {
              // Follow-up comment on existing open issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `**Follow-up reminder**: Only **${daysLeft} days** left until key expires on ${expiryDate}!`
              });
            }
