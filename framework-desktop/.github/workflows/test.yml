name: NixOS VM Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  vm-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v24
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Enable flakes
      run: |
        echo "experimental-features = nix-command flakes" | sudo tee -a /etc/nix/nix.conf
        sudo systemctl restart nix-daemon

    - name: Test flake configuration
      run: |
        nix flake check --verbose 2>&1 | tee flake-check.log

    - name: Run basic VM tests
      id: basic-vm-tests
      run: |
        # Run basic SDDM test
        nix build .#checks.x86_64-linux.hyprland-sddm --print-out-paths --no-link 2>&1 | tee basic-vm-test.log || true

    - name: Run comprehensive desktop integration tests
      id: desktop-tests
      run: |
        # Capture the store path for logs and screenshots
        TEST_RESULT_PATH=$(nix build .#checks.x86_64-linux.desktop-integration --print-out-paths --no-link 2>&1 | tee desktop-integration-test.log) || true

        # Try to get the actual test logs
        if [ -n "$TEST_RESULT_PATH" ]; then
          echo "TEST_LOG_PATH=$TEST_RESULT_PATH" >> $GITHUB_OUTPUT
          # Extract the derivation path from build output for full logs
          DERIVATION_PATH=$(grep -o '/nix/store/[^-]*-vm-test-run[^/]*\.drv' desktop-integration-test.log | head -1) || true
          if [ -n "$DERIVATION_PATH" ]; then
            echo "DERIVATION_PATH=$DERIVATION_PATH" >> $GITHUB_OUTPUT
            echo "Getting full logs from derivation..."
            nix log "$DERIVATION_PATH" > full-desktop-test.log 2>&1 || echo "Could not get derivation logs" > full-desktop-test.log
          fi
        fi

        # Check if tests passed
        if grep -q "error:" desktop-integration-test.log || grep -q "error:" basic-vm-test.log; then
          echo "Tests failed"
          exit 1
        fi
      continue-on-error: true

    - name: Collect test artifacts
      if: always()
      run: |
        # Create artifacts directory
        mkdir -p test-artifacts

        # Copy available logs
        [ -f flake-check.log ] && cp flake-check.log test-artifacts/
        [ -f basic-vm-test.log ] && cp basic-vm-test.log test-artifacts/
        [ -f desktop-integration-test.log ] && cp desktop-integration-test.log test-artifacts/
        [ -f full-desktop-test.log ] && cp full-desktop-test.log test-artifacts/

        # Copy HTML test report if available
        find /tmp -name "test-report.html" 2>/dev/null | head -1 | xargs -I {} cp {} test-artifacts/ 2>/dev/null || true

        # Try to get additional system logs and screenshots if available
        if [ -n "${{ steps.desktop-tests.outputs.TEST_LOG_PATH }}" ] && [ -d "${{ steps.desktop-tests.outputs.TEST_LOG_PATH }}" ]; then
          find "${{ steps.desktop-tests.outputs.TEST_LOG_PATH }}" -name "*.log" -o -name "*.png" 2>/dev/null | while read file; do
            cp "$file" test-artifacts/$(basename "$file") 2>/dev/null || true
          done
        fi

        # Get derivation logs if available
        if [ -n "${{ steps.desktop-tests.outputs.DERIVATION_PATH }}" ]; then
          echo "Derivation path: ${{ steps.desktop-tests.outputs.DERIVATION_PATH }}" > test-artifacts/derivation-info.txt
        fi

        # List what we collected
        echo "Collected artifacts:" > test-artifacts/manifest.txt
        ls -la test-artifacts/ >> test-artifacts/manifest.txt

    - name: Upload test artifacts and logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: vm-test-logs-and-artifacts
        path: test-artifacts/
        retention-days: 7

    - name: Upload desktop integration screenshots
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: desktop-integration-screenshots
        path: |
          **/*.png
          **/screenshot*.png
          **/*sddm*.png
          **/*desktop*.png
          **/*terminal*.png
          **/*rofi*.png
          **/*workspace*.png
        retention-days: 7
        if-no-files-found: ignore

    - name: Upload HTML test report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: desktop-test-report-html
        path: test-artifacts/test-report.html
        retention-days: 7
        if-no-files-found: ignore